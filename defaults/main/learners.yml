---
learners_vhost: "localhost"

# Base IP address for CORS settings
learners_base_ip: "{{ ansible_enp0s8.ipv4.address }}"

LEARNERS_ACCESS_TOKEN: "{{ lookup('env', 'LEARNERS_ACCESS_TOKEN') }}"

learners_user: "www-data"
learners_usergroup: "{{ learners_user }}"
learners_user_password: "password"

learners_paths:
  base: "/var/www/learners"
  log: "/var/log/learners"

learners_python_version: "3.8"

learners_git:
  user: "ait-cs-IaaS"
  repo: "learners"
  token: "{{ LEARNERS_ACCESS_TOKEN }}"
  branch: "master"
  force: yes
  always_reinstall: yes

learners_base_packages: 
  - "python{{ learners_python_version }}"
  - "python3-venv"
  - "python3-pip"
  - "git"

learners_nginx_packages:
  - "nginx"
  - "python3-passlib"
  - "apache2-utils"

learners_userlist:
  test: "{{ 'test' | password_hash('bcrypt') }}"
  ben: "{{ 'ben' | password_hash('bcrypt') }}"

learners_config:
  LEARNERS_HTPASSWD: "/etc/nginx/htpasswd"
  JWT_SECRET_KEY: "53CR3T"

learners_components:
  VENJIX_URL:     "http://127.0.0.1:5001"
  VNC_URL:        "https://placeholder_2@10.17.4.219/"
  DOCS_URL:       "http://{{ learners_base_ip }}:8080"
  EXERCISES_URL:  "http://{{ learners_base_ip }}:8888"
  CALLBACK_URL:   "http://{{ learners_base_ip }}:5000/callback"

learners_service_files:
  service:
    template: "learners.service.j2"
    destination: "/etc/systemd/system/learners.service"
  socket:
    template: "learners.socket.j2"
    destination: "/etc/systemd/system/learners.socket"

learners_service:
  name: "{{ (learners_service_files.service['destination'] | basename | split('.service'))[0] }}"
  user: "{{ learners_user }}"
  socket: "/run/learners.sock"
  group: "{{ learners_usergroup }}"
  RuntimeDirectory: "learners_runtime"
  WorkingDirectory: "{{ learners_paths.base }}"
  ExecStart: >
    {{ learners_paths.base }}/venv/bin/gunicorn 
    --workers 5
    wsgi:app
    --pythonpath={{ learners_paths.base }}/venv/lib/python{{ learners_python_version }}
  state: restarted
  autostart: yes
  reload: yes

learners_nginx:
  server_name: "learners.cyberrange.at"
  listen: "80 default_server"
  listen_ssl: "443 ssl default_server"
  ssl_cert: ""
  ssl_key: ""
  wwwroot: "{{ learners_paths.base }}"
  