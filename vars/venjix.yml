---
flask_app_name: "venjix"

flask_paths:
  base: "/var/www/venjix"
  log: "/var/log/venjix"

flask_python_version: "3.8"

flask_git:
  user: "ait-cs-IaaS"
  repo: "venjix"
  token: "{{ GIT_ACCESS_TOKEN }}"
  branch: "master"
  force: yes
  always_reinstall: yes


# -------------------------------------------
# *** Learners NGINX template ***
# -------------------------------------------

flask_nginx:
  src: "nginx_venjix.conf.j2"
  dest: "/etc/nginx/sites-enabled/venjix.conf"

venjix_nginx:
  server_name: "venjix.cyberrange.at"
  port: "{{ learners_ports.venjix }}"
  listen: "{{ learners_ports.venjix }} default_server"
  listen_ssl: "{{ learners_ports.venjix }} ssl default_server"
  ssl_cert: ""
  ssl_key: ""
  wwwroot: "{{ flask_paths.base }}"
  
  
# -------------------------------------------
# *** Learners Service ***
# -------------------------------------------

flask_service_files:
  service:
    template: "flask.service.j2"
    destination: "/etc/systemd/system/venjix.service"
  socket:
    template: "flask.socket.j2"
    destination: "/etc/systemd/system/venjix.socket"

flask_service:
  name: "{{ (flask_service_files.service['destination'] | basename | split('.service'))[0] }}"
  description: "venjix daemon"
  requires: "venjix.socket"
  user: "{{ flask_user }}"
  socket: "/run/venjix.sock"
  group: "{{ flask_usergroup }}"
  RuntimeDirectory: "venjix_runtime"
  WorkingDirectory: "{{ flask_paths.base }}"
  ExecStart: >
    {{ flask_paths.base }}/venv/bin/gunicorn 
    --workers 5
    wsgi:app
    -b 127.0.0.1:{{ learners_ports.venjix }}
    --pythonpath={{ flask_paths.base }}/venv/lib/python{{ flask_python_version }}
  state: restarted
  autostart: yes
  reload: yes