# -------------------------------------------
# *** Install Learners Environment ***
# -------------------------------------------

- name: Clone learners repo
  ansible.builtin.git:
    repo: "https://\
      {{ learners_git.token }}@github.com/\
      {{ learners_git.user }}/\
      {{ learners_git.repo }}.git"
    dest: "{{ learners_paths.base }}"
    version: "{{ learners_git.branch }}"
    force: "{{ learners_git.force }}"
    single_branch: yes
  become: yes
  become_user: "{{ learners_user }}"

- name: Setup virtualenv
  ansible.builtin.pip:
    requirements: "{{ learners_paths.base }}/requirements.txt"
    virtualenv: "{{ learners_paths.base }}/venv"
    virtualenv_command: 'python3 -m venv'
  become: yes
  become_user: "{{ learners_user }}"

- name: Setup learners config
  ansible.builtin.template:
    src: "learners_config.yml.j2"
    dest: "{{ learners_paths.base }}/learners_config.yml"
    owner: "{{ learners_user }}"
    group: "{{ learners_user }}"
    mode: '0644'
  become: yes
  become_user: "{{ learners_user }}"
  
- name: Add NGINX configuration file
  ansible.builtin.template:
    src: nginx_learners.conf.j2
    dest: /etc/nginx/sites-enabled/learners.conf
    owner: "{{ learners_user }}"
    group: "{{ learners_user }}"
    mode: 0644
  become: yes
  notify: restart nginx

- name: Ensure htpasswd credentials are configured
  community.general.htpasswd:
    path: "/etc/nginx/htpasswd"
    name: "{{ item.key }}"
    password: "{{ item.value }}"
    owner: "root"
    group: "www-data"
    crypt_scheme: plaintext # must be encrypted prior
    mode: "0640"
  loop: "{{ htpasswd_credentials | dict2items }}"
  become: yes
